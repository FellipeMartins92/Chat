<input type="hidden" id="user_id" value="{{ request.session.user_id }}">
<div class="col-md-9 d-flex flex-column justify-content-between p-0" style="height: 92vh;">
    <div id="message-container" class="flex-grow-1 p-4 overflow-auto" style="background-color: #343a40;">
        {% for message in messages %}
        {% if message.id_sender.id == request.session.user_id %}
            <div class="d-flex justify-content-end mb-2">
                <div class="bg-primary text-white p-2 rounded" style="max-width: 60%; text-align: right;">
                    {{ message.message }}
                </div>
            </div>
        {% else %}
            <div class="d-flex justify-content-start mb-2">
                <div class="bg-light text-dark p-2 rounded" style="max-width: 60%; text-align: left;">
                    {{ message.message }}
                </div>
            </div>
        {% endif %}
        {% endfor %}
    </div>
    <form id="message-form" method="POST" action="{% url 'Enviar_Mensagem' %}" class="bg-secondary bg-opacity-50">
        {% csrf_token %}
        <input type="hidden" name="id_receiver" id="id_receiver" value="{{ request.GET.id_receiver }}">
        <div class="d-flex align-items-center p-3">
            <input type="text" name="mensagem" id="mensagem" class="form-control bg-light text-dark me-2" placeholder="Digite sua mensagem..." required>
            <button type="submit" class="btn btn-primary rounded-circle"><i class="bi bi-send"></i></button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const container  = document.getElementById('message-container');
      const receiverId = document.getElementById('id_receiver').value;
      const userId     = document.getElementById('user_id').value;

      function carregarMensagens() {
        fetch(`/Atualizar_Messages/${receiverId}/`)
          .then(resp => resp.json())
          .then(data => {
            container.innerHTML = '';
            data.messages.forEach(msg => {
              const isSender = String(msg.id_sender) === String(userId);
              const wrap = document.createElement('div');
              wrap.className = `d-flex ${isSender
                ? 'justify-content-end'
                : 'justify-content-start'} mb-2`;

              wrap.innerHTML = `
                <div class="${isSender
                  ? 'bg-primary text-white'
                  : 'bg-light text-dark'} p-2 rounded"
                     style="max-width:60%; text-align:${isSender?'right':'left'};">
                  ${msg.message}
                </div>`;
              container.appendChild(wrap);
            });
            container.scrollTop = container.scrollHeight;
          })
          .catch(console.error);
      }

      carregarMensagens();
      setInterval(carregarMensagens, 3000);
    });
  </script>